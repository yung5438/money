import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, collection, addDoc, onSnapshot, 
  deleteDoc, doc, query, orderBy, Timestamp, updateDoc 
} from 'firebase/firestore';
import { 
  getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken
} from 'firebase/auth';
import { 
  Wallet, Plus, Users, Calendar, Trash2, 
  Plane, ShoppingBag, Utensils, Hotel, Train, 
  ArrowRightLeft, CheckCircle, PiggyBank, Edit, X, RefreshCw, Download, Check, Upload, Copy, AlertCircle
} from 'lucide-react';

// --- Firebase Configuration & Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Constants & Config ---
const TRIP_START = new Date('2026-03-02');
const TRIP_END = new Date('2026-03-15');
const DEFAULT_MEMBERS = ['楊清吉', '楊于鋒', '蔡堃傑'];

const CATEGORIES = [
  { id: 'food', name: '餐飲', icon: <Utensils size={18} />, color: 'bg-orange-100 text-orange-600' },
  { id: 'transport', name: '交通', icon: <Train size={18} />, color: 'bg-blue-100 text-blue-600' },
  { id: 'shopping', name: '購物', icon: <ShoppingBag size={18} />, color: 'bg-pink-100 text-pink-600' },
  { id: 'hotel', name: '住宿', icon: <Hotel size={18} />, color: 'bg-indigo-100 text-indigo-600' },
  { id: 'flight', name: '機票', icon: <Plane size={18} />, color: 'bg-sky-100 text-sky-600' },
  { id: 'other', name: '其他', icon: <Wallet size={18} />, color: 'bg-gray-100 text-gray-600' },
];

// --- Helper Components ---
const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-2xl shadow-sm border border-pink-50 ${className}`}>
    {children}
  </div>
);

const Badge = ({ children, colorClass }) => (
  <span className={`px-2 py-1 rounded-full text-xs font-medium ${colorClass}`}>
    {children}
  </span>
);

// --- Main Application Component ---
export default function TokyoTripLedger() {
  const [user, setUser] = useState(null);
  const [expenses, setExpenses] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('dashboard');
  
  // State for Exchange Rate (Default 0.22)
  const [exchangeRate, setExchangeRate] = useState(0.22);
  const [isRatesLoading, setIsRatesLoading] = useState(false);
  
  // Form State
  const [editingId, setEditingId] = useState(null); 
  const [amount, setAmount] = useState('');
  const [currency, setCurrency] = useState('JPY'); // 'JPY' or 'TWD'
  const [description, setDescription] = useState('');
  const [category, setCategory] = useState('food');
  const [payer, setPayer] = useState(DEFAULT_MEMBERS[0]);
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  // New: Involved Members Selection
  const [involvedMembers, setInvolvedMembers] = useState(DEFAULT_MEMBERS);

  // New: Delete Confirmation State
  const [deleteConfirmId, setDeleteConfirmId] = useState(null);

  // File Upload Ref
  const fileInputRef = useRef(null);

  // --- Firebase Logic ---

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const q = collection(db, 'artifacts', appId, 'public', 'data', 'tokyo_trip_expenses');
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      data.sort((a, b) => b.timestamp?.seconds - a.timestamp?.seconds);
      setExpenses(data);
      setLoading(false);
    }, (error) => {
      console.error("Error fetching data:", error);
      setLoading(false);
    });
    return () => unsubscribe();
  }, [user]);

  // --- Exchange Rate Logic ---
  const fetchExchangeRate = async () => {
    setIsRatesLoading(true);
    try {
      const response = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
      const data = await response.json();
      if (data && data.rates && data.rates.TWD) {
        setExchangeRate(data.rates.TWD);
      } else {
        console.warn("Could not find TWD in response");
      }
    } catch (error) {
      console.error("Failed to fetch rates:", error);
    } finally {
      setIsRatesLoading(false);
    }
  };

  useEffect(() => {
    fetchExchangeRate();
  }, []);

  // --- Actions ---

  const handleEditClick = (exp) => {
    setEditingId(exp.id);
    const inputCurr = exp.inputCurrency || 'JPY';
    setCurrency(inputCurr);
    setAmount(exp.inputAmount ? exp.inputAmount.toString() : exp.amount.toString());
    setDescription(exp.description);
    setCategory(exp.category);
    setPayer(exp.payer);
    setDate(exp.date);
    // Load saved involved members, default to all if missing (legacy data)
    setInvolvedMembers(exp.involved || DEFAULT_MEMBERS);
    
    setActiveTab('add'); 
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const cancelEdit = () => {
    setEditingId(null);
    setAmount('');
    setCurrency('JPY');
    setDescription('');
    setCategory('food');
    setPayer(DEFAULT_MEMBERS[0]);
    setDate(new Date().toISOString().split('T')[0]);
    setInvolvedMembers(DEFAULT_MEMBERS); // Reset to all selected
  };

  const toggleInvolvedMember = (member) => {
    if (involvedMembers.includes(member)) {
      // Prevent removing the last person
      if (involvedMembers.length > 1) {
        setInvolvedMembers(prev => prev.filter(m => m !== member));
      }
    } else {
      setInvolvedMembers(prev => [...prev, member]);
    }
  };

  const handleSaveExpense = async (e) => {
    e.preventDefault();
    if (!amount || !description) return;
    setIsSubmitting(true);

    try {
      const numericAmount = parseFloat(amount);
      let baseAmountJPY = numericAmount;
      if (currency === 'TWD') {
        baseAmountJPY = numericAmount / exchangeRate;
      }

      const expenseData = {
        amount: baseAmountJPY, 
        inputCurrency: currency, 
        inputAmount: numericAmount, 
        description,
        category,
        payer,
        date,
        involved: involvedMembers // Save the user-selected array
      };

      if (editingId) {
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'tokyo_trip_expenses', editingId);
        await updateDoc(docRef, expenseData);
      } else {
        const newDoc = {
          ...expenseData,
          timestamp: Timestamp.now(),
        };
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tokyo_trip_expenses'), newDoc);
      }
      
      cancelEdit(); 
      setActiveTab('dashboard');
    } catch (error) {
      console.error("Error saving expense:", error);
      alert("儲存失敗，請重試");
    } finally {
      setIsSubmitting(false);
    }
  };

  // Replace native confirm with UI state
  const requestDelete = (id) => {
    setDeleteConfirmId(id);
  };

  const confirmDelete = async (id) => {
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tokyo_trip_expenses', id));
      setDeleteConfirmId(null);
    } catch (error) {
      console.error("Error deleting:", error);
      alert("刪除失敗，請稍後再試");
    }
  };

  const cancelDelete = () => {
    setDeleteConfirmId(null);
  };

  // --- CSV Helpers ---
  const getCSVContent = () => {
    if (expenses.length === 0) return null;

    const headers = ["日期", "項目說明", "分類", "付款人", "分攤人數", "分攤對象", "金額 (JPY)", "金額 (TWD) (估算)", "原始輸入幣別", "原始輸入金額"];
    
    const csvRows = expenses.map(exp => {
      const categoryName = CATEGORIES.find(c => c.id === exp.category)?.name || exp.category;
      const amountTWD = Math.round(exp.amount * exchangeRate);
      // Escape quotes: replace " with "" and wrap in "
      const safeDescription = `"${exp.description.replace(/"/g, '""')}"`;
      
      const currentInvolved = exp.involved || DEFAULT_MEMBERS;
      const splitInfo = `${currentInvolved.length}人`;
      const involvedNames = `"${currentInvolved.join('、')}"`;

      return [
        exp.date,
        safeDescription,
        categoryName,
        exp.payer,
        splitInfo,
        involvedNames,
        exp.amount,
        amountTWD,
        exp.inputCurrency || 'JPY',
        exp.inputAmount || exp.amount
      ].join(",");
    });

    return [headers.join(","), ...csvRows].join("\n");
  };

  const handleExportCSV = () => {
    const csvContent = getCSVContent();
    if (!csvContent) {
      alert("目前沒有資料可匯出");
      return;
    }

    const bom = "\uFEFF";
    const blob = new Blob([bom + csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", `東京之旅帳務明細_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleCopyCSV = () => {
    const csvContent = getCSVContent();
    if (!csvContent) {
      alert("目前沒有資料可複製");
      return;
    }

    // Create a hidden textarea to facilitate copying in standard environments
    const textArea = document.createElement("textarea");
    textArea.value = csvContent;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      alert("資料已複製到剪貼簿！\n您可以直接貼上到 LINE、備忘錄或 Google 試算表。");
    } catch (err) {
      console.error('Fallback: Oops, unable to copy', err);
      alert("複製失敗，請手動匯出");
    }
    document.body.removeChild(textArea);
  };

  // --- Import Logic ---
  const handleImportClick = () => {
    fileInputRef.current.click();
  };

  const handleFileChange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
        alert("請上傳 CSV 格式的檔案");
        return;
    }

    const reader = new FileReader();
    reader.onload = async (event) => {
        try {
            let csvText = event.target.result;
            // Remove BOM if present
            if (csvText.charCodeAt(0) === 0xFEFF) {
                csvText = csvText.slice(1);
            }

            const lines = csvText.split(/\r\n|\n/);
            // Skip header
            const dataLines = lines.slice(1).filter(line => line.trim() !== '');
            
            if (dataLines.length === 0) {
                alert("檔案內容為空");
                return;
            }

            if (!confirm(`準備匯入 ${dataLines.length} 筆資料，確定嗎？`)) return;

            let successCount = 0;
            
            for (const line of dataLines) {
                const columns = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (columns.length < 7) continue; 

                const date = columns[0].trim();
                let description = columns[1].trim();
                if (description.startsWith('"') && description.endsWith('"')) {
                    description = description.slice(1, -1).replace(/""/g, '"');
                }
                
                const categoryName = columns[2].trim();
                const categoryObj = CATEGORIES.find(c => c.name === categoryName);
                const category = categoryObj ? categoryObj.id : 'other';
                
                const payer = columns[3].trim();
                const validPayer = DEFAULT_MEMBERS.includes(payer) ? payer : DEFAULT_MEMBERS[0];

                const amountJPY = parseFloat(columns[6]);
                if (isNaN(amountJPY)) continue;

                let involved = DEFAULT_MEMBERS;
                const involvedStr = columns[5].trim(); 
                let cleanInvolvedStr = involvedStr;
                if (cleanInvolvedStr.startsWith('"') && cleanInvolvedStr.endsWith('"')) {
                    cleanInvolvedStr = cleanInvolvedStr.slice(1, -1);
                }
                
                if (cleanInvolvedStr) {
                    const parsedMembers = cleanInvolvedStr.split('、');
                    const validMembers = parsedMembers.filter(m => DEFAULT_MEMBERS.includes(m));
                    if (validMembers.length > 0) involved = validMembers;
                }

                const inputCurrency = columns[8] ? columns[8].trim() : 'JPY';
                const inputAmount = columns[9] ? parseFloat(columns[9]) : amountJPY;

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tokyo_trip_expenses'), {
                    date,
                    description,
                    category,
                    payer: validPayer,
                    amount: amountJPY,
                    involved,
                    inputCurrency,
                    inputAmount,
                    timestamp: Timestamp.now()
                });
                
                successCount++;
            }
            
            alert(`成功匯入 ${successCount} 筆資料！`);
            e.target.value = '';

        } catch (error) {
            console.error("Import error:", error);
            alert("匯入失敗，請檢查檔案格式");
        }
    };
    reader.readAsText(file);
  };

  // --- Calculations ---

  const stats = useMemo(() => {
    let total = 0;
    const paidBy = {};     
    const consumption = {}; 
    
    DEFAULT_MEMBERS.forEach(m => { 
      paidBy[m] = 0; 
      consumption[m] = 0;
    });

    expenses.forEach(exp => {
      total += exp.amount;
      
      if (paidBy[exp.payer] !== undefined) {
        paidBy[exp.payer] += exp.amount;
      }

      const currentInvolved = exp.involved || DEFAULT_MEMBERS;
      
      if (currentInvolved.length > 0) {
        const splitAmount = exp.amount / currentInvolved.length;
        
        currentInvolved.forEach(member => {
          if (consumption[member] !== undefined) {
            consumption[member] += splitAmount;
          }
        });
      }
    });

    const balances = DEFAULT_MEMBERS.map(member => ({
      member,
      paid: paidBy[member],
      consumed: consumption[member],
      balance: paidBy[member] - consumption[member] 
    }));

    return { total, paidBy, consumption, balances };
  }, [expenses]);

  const settlements = useMemo(() => {
    let debtors = stats.balances.filter(b => b.balance < -1).sort((a, b) => a.balance - b.balance);
    let creditors = stats.balances.filter(b => b.balance > 1).sort((a, b) => b.balance - a.balance);
    
    const transactions = [];
    let i = 0; 
    let j = 0; 

    while (i < debtors.length && j < creditors.length) {
      let debtor = debtors[i];
      let creditor = creditors[j];
      
      let amount = Math.min(Math.abs(debtor.balance), creditor.balance);
      
      transactions.push({
        from: debtor.member,
        to: creditor.member,
        amount: Math.round(amount)
      });

      debtor.balance += amount;
      creditor.balance -= amount;

      if (Math.abs(debtor.balance) < 1) i++;
      if (creditor.balance < 1) j++;
    }
    return transactions;
  }, [stats]);

  // --- Views ---

  const renderDashboard = () => (
    <div className="space-y-6 pb-20">
      {/* Header Banner */}
      <div className="bg-gradient-to-r from-pink-500 to-rose-400 p-6 rounded-3xl text-white shadow-lg relative overflow-hidden">
        <div className="absolute top-0 right-0 opacity-20 transform translate-x-4 -translate-y-4">
          <Plane size={120} />
        </div>
        
        <div className="relative z-10">
            <div className="flex justify-between items-start mb-2">
                <h2 className="text-sm font-medium opacity-90">東京之旅 (3/2 - 3/15)</h2>
                <div className="flex items-center bg-white/20 rounded-lg px-2 py-1 backdrop-blur-sm gap-2">
                    <span className="text-xs opacity-90">匯率</span>
                    <input 
                        type="number" 
                        step="0.001"
                        value={exchangeRate}
                        onChange={(e) => setExchangeRate(parseFloat(e.target.value))}
                        className="w-16 bg-transparent text-white text-right font-bold text-sm focus:outline-none border-b border-white/50"
                    />
                    <button 
                      onClick={fetchExchangeRate}
                      disabled={isRatesLoading}
                      className={`p-1 rounded-full hover:bg-white/20 transition-all ${isRatesLoading ? 'animate-spin' : ''}`}
                      title="更新即時匯率"
                    >
                      <RefreshCw size={12} className="text-white" />
                    </button>
                </div>
            </div>
            
            <div className="mt-4">
                <div className="flex items-baseline gap-2">
                    <span className="text-4xl font-bold">NT$ {Math.round(stats.total * exchangeRate).toLocaleString()}</span>
                </div>
                <div className="text-sm opacity-80 mt-1">
                    總支出 ¥ {stats.total.toLocaleString()}
                </div>
            </div>
        </div>
      </div>

      {/* Quick Stats */}
      <div>
        <h3 className="text-sm font-bold text-gray-700 mb-3 px-1">每人已墊付金額</h3>
        <div className="grid grid-cols-3 gap-3">
          {stats.balances.map((b) => (
            <Card key={b.member} className="p-3 text-center flex flex-col items-center justify-between min-h-[100px] border-blue-50 relative overflow-hidden">
              <div className="font-bold text-gray-800 text-sm mb-1 z-10">{b.member}</div>
              
              <div className="z-10 w-full">
                <div className="text-[10px] text-gray-400 mb-0.5">墊付 (台幣)</div>
                <div className="font-bold text-blue-600 text-base leading-tight">
                  ${Math.round(stats.paidBy[b.member] * exchangeRate).toLocaleString()}
                </div>
                <div className="text-[9px] text-gray-300 font-mono">
                  (¥{Math.round(stats.paidBy[b.member]).toLocaleString()})
                </div>
              </div>

              <div className={`mt-2 text-[10px] px-2 py-0.5 rounded-full font-medium w-full z-10 ${b.balance >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                {b.balance >= 0 ? '應收' : '應付'} ${Math.round(Math.abs(b.balance) * exchangeRate).toLocaleString()}
              </div>
            </Card>
          ))}
        </div>
      </div>

      {/* Recent Activity */}
      <div>
        <div className="flex justify-between items-center mb-3 px-1">
          <h3 className="font-bold text-gray-800">最近支出</h3>
          <button onClick={() => setActiveTab('history')} className="text-xs text-pink-500 font-medium">查看全部</button>
        </div>
        <div className="space-y-3">
          {expenses.length === 0 ? (
            <div className="text-center py-8 text-gray-400 text-sm bg-gray-50 rounded-xl border border-dashed border-gray-200">
              還沒有記帳喔！點擊下方 + 開始
            </div>
          ) : (
            expenses.slice(0, 3).map((exp) => {
               const currentInvolved = exp.involved || DEFAULT_MEMBERS;
               return (
                <Card key={exp.id} className="p-4 flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className={`p-2 rounded-full ${CATEGORIES.find(c => c.id === exp.category)?.color || 'bg-gray-100'}`}>
                      {CATEGORIES.find(c => c.id === exp.category)?.icon}
                    </div>
                    <div>
                      <div className="font-bold text-gray-800">{exp.description}</div>
                      <div className="text-xs text-gray-500 flex items-center gap-1">
                        {exp.date} • {exp.payer} 墊付
                      </div>
                    </div>
                  </div>
                  <div className="flex flex-col items-end">
                    <div className="font-bold text-gray-800 text-lg">
                      NT$ {Math.round(exp.amount * exchangeRate).toLocaleString()}
                    </div>
                    <div className="flex items-center gap-2 mt-1">
                       <span className="text-[10px] bg-gray-100 text-gray-500 px-1.5 rounded">{currentInvolved.length}人分</span>
                       <button 
                          onClick={() => handleEditClick(exp)}
                          className="p-1 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200"
                       >
                          <Edit size={12} />
                       </button>
                    </div>
                  </div>
                </Card>
              );
            })
          )}
        </div>
      </div>
    </div>
  );

  const renderAddExpense = () => {
    return (
      <div className="pb-20">
        <div className="flex justify-between items-center mb-6 px-1">
           <h2 className="text-xl font-bold text-gray-800">{editingId ? '編輯支出' : '新增一筆支出'}</h2>
           {editingId && (
              <button onClick={cancelEdit} className="text-gray-500 bg-gray-200 p-2 rounded-full hover:bg-gray-300">
                  <X size={20} />
              </button>
           )}
        </div>
        
        <form onSubmit={handleSaveExpense} className="space-y-5">
          {/* Amount Input */}
          <div className={`bg-white p-4 rounded-2xl border shadow-sm ${editingId ? 'border-blue-200 ring-2 ring-blue-100' : 'border-pink-100'}`}>
            <div className="flex justify-between items-center mb-2">
              <label className="block text-xs font-medium text-gray-500">金額</label>
              <div className="flex bg-gray-100 p-1 rounded-lg">
                  <button
                      type="button"
                      onClick={() => setCurrency('JPY')}
                      className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${currency === 'JPY' ? 'bg-white shadow text-pink-600' : 'text-gray-400'}`}
                  >
                      JPY (日幣)
                  </button>
                  <button
                      type="button"
                      onClick={() => setCurrency('TWD')}
                      className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${currency === 'TWD' ? 'bg-white shadow text-pink-600' : 'text-gray-400'}`}
                  >
                      TWD (台幣)
                  </button>
              </div>
            </div>

            <div className="flex items-center">
              <span className="text-2xl font-bold text-gray-400 mr-2">{currency === 'JPY' ? '¥' : 'NT$'}</span>
              <input 
                type="number" 
                inputMode="decimal"
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
                placeholder="0"
                className="w-full text-3xl font-bold text-gray-800 focus:outline-none placeholder-gray-200"
                autoFocus={!editingId}
              />
            </div>
            
            <div className="text-right text-sm text-gray-400 mt-2 font-medium flex justify-end items-center gap-2 bg-gray-50 p-2 rounded-lg">
               <RefreshCw size={12} className="text-gray-400" />
               {currency === 'JPY' ? (
                   <>約合 NT$ <span className="text-gray-700 font-bold">{amount ? Math.round(parseFloat(amount) * exchangeRate).toLocaleString() : '0'}</span></>
               ) : (
                   <>換算 ¥ <span className="text-gray-700 font-bold">{amount ? Math.round(parseFloat(amount) / exchangeRate).toLocaleString() : '0'}</span></>
               )}
            </div>
          </div>

          {/* Details */}
          <Card className="p-4 space-y-4">
            <div>
              <label className="block text-xs font-medium text-gray-500 mb-2">項目說明</label>
              <input 
                type="text" 
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                placeholder="例如：新宿拉麵"
                className="w-full text-lg border-b border-gray-200 focus:border-pink-500 focus:outline-none pb-2"
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-xs font-medium text-gray-500 mb-2">分類</label>
                <select 
                  value={category}
                  onChange={(e) => setCategory(e.target.value)}
                  className="w-full bg-gray-50 p-2 rounded-lg text-sm focus:outline-none"
                >
                  {CATEGORIES.map(c => (
                    <option key={c.id} value={c.id}>{c.name}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-500 mb-2">誰先付錢？</label>
                <select 
                  value={payer}
                  onChange={(e) => setPayer(e.target.value)}
                  className="w-full bg-gray-50 p-2 rounded-lg text-sm focus:outline-none"
                >
                  {DEFAULT_MEMBERS.map(m => (
                    <option key={m} value={m}>{m}</option>
                  ))}
                </select>
              </div>
            </div>

            <div>
               <label className="block text-xs font-medium text-gray-500 mb-2">日期</label>
               <input 
                type="date"
                value={date}
                onChange={(e) => setDate(e.target.value)}
                className="w-full bg-gray-50 p-2 rounded-lg text-sm focus:outline-none"
               />
            </div>

            {/* Split Members Selection */}
            <div>
               <label className="block text-xs font-medium text-gray-500 mb-2">分攤對象 (誰參與消費？)</label>
               <div className="flex flex-wrap gap-2">
                 {DEFAULT_MEMBERS.map(member => {
                   const isSelected = involvedMembers.includes(member);
                   return (
                     <button
                        key={member}
                        type="button"
                        onClick={() => toggleInvolvedMember(member)}
                        className={`px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${
                          isSelected 
                            ? 'bg-blue-100 text-blue-700 border border-blue-200' 
                            : 'bg-gray-50 text-gray-400 border border-transparent'
                        }`}
                     >
                       {isSelected ? <CheckCircle size={16} className="text-blue-500"/> : <div className="w-4 h-4 rounded-full border-2 border-gray-300" />}
                       {member}
                     </button>
                   );
                 })}
               </div>
               <div className="mt-2 text-[10px] text-gray-400">
                 * 預設全選，若有人離開或未參與此行程，請點擊取消選取。
               </div>
            </div>
          </Card>

          <button 
            disabled={isSubmitting || !amount || !description}
            type="submit" 
            className={`w-full py-4 text-white rounded-2xl font-bold shadow-lg transition-all disabled:opacity-50 disabled:shadow-none flex items-center justify-center gap-2 ${editingId ? 'bg-blue-500 hover:bg-blue-600 shadow-blue-200' : 'bg-pink-500 hover:bg-pink-600 shadow-pink-200'}`}
          >
            {isSubmitting ? '儲存中...' : (editingId ? <><Edit size={20} /> 確認修改</> : <><Plus size={20} /> 記一筆 ({currency})</>)}
          </button>
        </form>
      </div>
    );
  };

  const renderHistory = () => (
    <div className="pb-20">
      <div className="flex flex-col gap-2 mb-4 px-1">
        <h2 className="text-xl font-bold text-gray-800">帳務明細</h2>
        
        {/* Tools Bar */}
        <div className="flex items-center gap-2 overflow-x-auto pb-1 scrollbar-hide">
            <input 
                type="file" 
                ref={fileInputRef} 
                onChange={handleFileChange} 
                accept=".csv" 
                className="hidden" 
            />
            
            <button 
                onClick={handleCopyCSV}
                className="flex items-center gap-1 bg-gray-100 text-gray-700 px-3 py-2 rounded-xl text-xs font-bold shadow-sm active:scale-95 transition-all whitespace-nowrap"
            >
                <Copy size={14} /> 複製資料 (手機用)
            </button>

            <button 
                onClick={handleImportClick}
                className="flex items-center gap-1 bg-blue-50 text-blue-600 px-3 py-2 rounded-xl text-xs font-bold shadow-sm active:scale-95 transition-all whitespace-nowrap"
            >
                <Upload size={14} /> 匯入 CSV
            </button>
            
            <button 
                onClick={handleExportCSV}
                className="flex items-center gap-1 bg-green-50 text-green-600 px-3 py-2 rounded-xl text-xs font-bold shadow-sm active:scale-95 transition-all whitespace-nowrap"
            >
                <Download size={14} /> 下載檔案
            </button>
        </div>
      </div>
      
      <div className="space-y-3">
        {expenses.map((exp) => {
          const currentInvolved = exp.involved || DEFAULT_MEMBERS;
          return (
            <Card key={exp.id} className="p-4">
              <div className="flex justify-between items-start mb-2">
                <div className="flex items-center gap-3">
                   <div className={`p-2 rounded-full ${CATEGORIES.find(c => c.id === exp.category)?.color}`}>
                      {CATEGORIES.find(c => c.id === exp.category)?.icon}
                    </div>
                    <div>
                      <div className="font-bold text-gray-800">{exp.description}</div>
                      <div className="text-xs text-gray-400">{exp.date}</div>
                    </div>
                </div>
                <div className="text-right">
                  <div className="font-bold text-gray-800 text-lg">NT$ {Math.round(exp.amount * exchangeRate).toLocaleString()}</div>
                  <div className="text-xs text-gray-400 font-mono">
                     ¥ {exp.amount.toLocaleString()}
                  </div>
                  {exp.inputCurrency === 'TWD' && (
                      <span className="text-[10px] bg-blue-50 text-blue-400 px-1 rounded ml-1">TWD入帳</span>
                  )}
                  <div className="flex items-center justify-end gap-1 mt-1">
                    <span className="text-[10px] bg-gray-100 text-gray-500 px-1.5 rounded">{currentInvolved.length}人分</span>
                    <Badge colorClass="bg-gray-100 text-gray-500">{exp.payer} 付</Badge>
                  </div>
                </div>
              </div>
              
              <div className="flex justify-end pt-2 border-t border-gray-50 mt-2 gap-3">
                 {deleteConfirmId === exp.id ? (
                    <div className="flex items-center gap-2 bg-red-50 px-2 py-1 rounded-lg">
                      <span className="text-xs text-red-600 font-bold flex items-center gap-1">
                        <AlertCircle size={12}/> 確定刪除？
                      </span>
                      <button 
                        onClick={() => confirmDelete(exp.id)}
                        className="text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600"
                      >
                        是
                      </button>
                      <button 
                        onClick={cancelDelete}
                        className="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded hover:bg-gray-300"
                      >
                        否
                      </button>
                    </div>
                 ) : (
                   <>
                    <button 
                      onClick={() => handleEditClick(exp)}
                      className="text-xs text-blue-500 flex items-center gap-1 hover:text-blue-700 bg-blue-50 px-3 py-1.5 rounded-lg"
                    >
                      <Edit size={12} /> 編輯
                    </button>
                    <button 
                      onClick={() => requestDelete(exp.id)}
                      className="text-xs text-red-500 flex items-center gap-1 hover:text-red-700 bg-red-50 px-3 py-1.5 rounded-lg"
                    >
                      <Trash2 size={12} /> 刪除
                    </button>
                   </>
                 )}
              </div>
            </Card>
          );
        })}
        {expenses.length === 0 && (
          <div className="text-center text-gray-400 mt-10">尚無資料</div>
        )}
      </div>
    </div>
  );

  const renderSettlement = () => (
    <div className="pb-20">
      <h2 className="text-xl font-bold text-gray-800 mb-4 px-1">結帳建議</h2>
      
      <Card className="p-6 bg-gradient-to-br from-indigo-500 to-purple-600 text-white mb-6">
        <div className="flex items-center gap-3 mb-4">
          <PiggyBank size={24} className="text-yellow-300" />
          <h3 className="font-bold text-lg">分帳狀態</h3>
        </div>
        <div className="space-y-2">
            {DEFAULT_MEMBERS.map(m => (
                <div key={m} className="flex justify-between items-center border-b border-white/20 pb-1 last:border-0">
                    <span className="opacity-90 text-sm">{m} 應付(消費):</span>
                    <span className="font-mono font-bold">NT$ {Math.round(stats.consumption[m] * exchangeRate).toLocaleString()}</span>
                </div>
            ))}
        </div>
        <div className="text-[10px] opacity-60 mt-4 text-right">以匯率 {exchangeRate} 計算</div>
      </Card>

      <h3 className="text-sm font-bold text-gray-600 mb-3 px-1">轉帳指南 (最佳化)</h3>
      <div className="space-y-3">
        {settlements.length === 0 ? (
           <Card className="p-8 text-center text-gray-500 flex flex-col items-center">
             <CheckCircle size={48} className="text-green-500 mb-3" />
             <p>目前帳務已平衡，無需轉帳！</p>
           </Card>
        ) : (
          settlements.map((s, idx) => (
            <Card key={idx} className="p-4 flex items-center justify-between border-l-4 border-l-pink-500">
              <div className="flex items-center gap-2">
                <div className="font-bold text-gray-800">{s.from}</div>
                <div className="text-gray-400"><ArrowRightLeft size={16} /></div>
                <div className="font-bold text-gray-800">{s.to}</div>
              </div>
              <div className="text-right">
                <div className="text-xs text-gray-500 mb-1">應支付 (台幣)</div>
                <div className="font-bold text-pink-600 text-xl">NT$ {Math.round(s.amount * exchangeRate).toLocaleString()}</div>
                <div className="text-xs text-gray-400">
                   (¥ {s.amount.toLocaleString()})
                </div>
              </div>
            </Card>
          ))
        )}
      </div>
      
      <div className="mt-8 text-xs text-gray-400 text-center px-4 leading-relaxed">
        * 匯率設定：{exchangeRate}。<br/>
        * 彈性分帳：依據每筆帳目紀錄的參與人數計算。<br/>
        * 建議回國後確認最終刷卡匯率，再手動調整上方匯率欄位。
      </div>
    </div>
  );

  // --- Render ---

  if (loading) return (
    <div className="h-screen w-full flex flex-col items-center justify-center bg-gray-50">
      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500 mb-4"></div>
      <div className="text-gray-500 text-sm animate-pulse">正在載入東京帳本...</div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-900 max-w-md mx-auto shadow-2xl overflow-hidden relative">
      
      {/* Top Bar */}
      <div className="bg-white px-4 py-3 sticky top-0 z-10 shadow-sm flex justify-between items-center">
        <h1 className="font-bold text-lg text-pink-500 flex items-center gap-2">
          <Plane size={20} /> Tokyo 2026
        </h1>
        <div className="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full">
          {user ? '已連線' : '連線中...'}
        </div>
      </div>

      {/* Main Content Area */}
      <div className="p-4 min-h-[calc(100vh-140px)]">
        {activeTab === 'dashboard' && renderDashboard()}
        {activeTab === 'add' && renderAddExpense()}
        {activeTab === 'history' && renderHistory()}
        {activeTab === 'settle' && renderSettlement()}
      </div>

      {/* Bottom Navigation */}
      <div className="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-100 pb-safe shadow-[0_-5px_10px_rgba(0,0,0,0.02)] z-20">
        <div className="flex justify-around items-center p-2">
          <button 
            onClick={() => { setActiveTab('dashboard'); cancelEdit(); }}
            className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'dashboard' ? 'text-pink-500 bg-pink-50' : 'text-gray-400'}`}
          >
            <Calendar size={24} />
            <span className="text-[10px] font-medium mt-1">概覽</span>
          </button>
          
          <button 
            onClick={() => { setActiveTab('add'); if(!editingId) cancelEdit(); }}
            className={`flex flex-col items-center justify-center -mt-6 rounded-full h-14 w-14 shadow-lg hover:scale-105 transition-transform ${editingId ? 'bg-blue-500 shadow-blue-300' : 'bg-pink-500 shadow-pink-300'} text-white`}
          >
            {editingId ? <Edit size={28} /> : <Plus size={32} />}
          </button>

          <button 
            onClick={() => { setActiveTab('history'); cancelEdit(); }}
            className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'history' ? 'text-pink-500 bg-pink-50' : 'text-gray-400'}`}
          >
            <Users size={24} />
            <span className="text-[10px] font-medium mt-1">明細</span>
          </button>

          <button 
            onClick={() => { setActiveTab('settle'); cancelEdit(); }}
            className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'settle' ? 'text-pink-500 bg-pink-50' : 'text-gray-400'}`}
          >
            <ArrowRightLeft size={24} />
            <span className="text-[10px] font-medium mt-1">結帳</span>
          </button>
        </div>
      </div>
    </div>
  );
}